name: Telegram Notification
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –∫–æ–º–º–∏—Ç–æ–≤

      # –®–∞–≥ 2: –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–º–∏—Ç–∞—Ö
      - name: Get commit details
        id: commits
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ push
          echo "COMMITS<<EOF" >> $GITHUB_OUTPUT
          git log --pretty=format:'%h - %an: %s (%ar)' HEAD^..HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ –∏–ª–∏ dev
          echo "VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo 'dev')" >> $GITHUB_OUTPUT
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
          echo "FILES<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only HEAD^ HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # –®–∞–≥ 3: –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      - name: Prepare message
        id: message
        run: |
          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è MarkdownV2
          COMMITS=$(echo '${{ steps.commits.outputs.COMMITS }}' | sed -e 's/[][()_*`]/\\&/g')
          FILES=$(echo '${{ steps.commits.outputs.FILES }}' | sed -e 's/[][()_*`]/\\&/g')
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE=$(cat <<EOF
          üöÄ *–ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏* \\[${GITHUB_REPOSITORY}\\]
          
          üìù *–ö–æ–º–º–∏—Ç—ã:*
          \`\`\`
          ${COMMITS}
          \`\`\`
          
          üìÇ *–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:*
          \`\`\`
          ${FILES}
          \`\`\`
          
          üë§ *–ê–≤—Ç–æ—Ä:* ${GITHUB_ACTOR}
          üè∑ *–í–µ—Ä—Å–∏—è:* ${{ steps.commits.outputs.VERSION }}
          üîó *–°—Å—ã–ª–∫–∞:* [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è](https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA})
          EOF
          )
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —à–∞–≥–∞
          echo "MESSAGE=${MESSAGE}" >> $GITHUB_OUTPUT
          echo "Generated message:"
          echo "${MESSAGE}"

      # –®–∞–≥ 4: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
      - name: Send Telegram notification
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": "'"${{ steps.message.outputs.MESSAGE }}"'",
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }' \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"

      # –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Verify delivery
        run: |
          echo "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram"
          echo "–ß–∞—Ç ID: 5615087670"
          echo "–í–µ—Ä—Å–∏—è –±–æ—Ç–∞: 7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q"
