name: Git Changes Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare notification data
        id: prepare
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')
          COMMIT_LINK="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          CHANGES=$(git diff --name-status HEAD^ HEAD | while read status file; do
            case $status in
              A) echo "‚Ä¢ üÜï $file";;
              M) echo "‚Ä¢ ‚úèÔ∏è $file";;
              D) echo "‚Ä¢ ‚ùå $file";;
              R*) echo "‚Ä¢ ‚ôªÔ∏è ${file#*$'\t'}";;
              C) echo "‚Ä¢ ¬©Ô∏è $file";;
              *) echo "‚Ä¢ üîÑ $file";;
            done | tr '\n' '\t')

          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π
          DETAILS=$(git diff --stat HEAD^ HEAD)

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
          MESSAGE="üìå *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ*: ${GITHUB_REPOSITORY##*/}
          
          üìù *–ö–æ–º–º–∏—Ç*: $COMMIT_MSG
          üë§ *–ê–≤—Ç–æ—Ä*: $AUTHOR
          üìÖ *–î–∞—Ç–∞*: $DATE
          
          üìÇ *–ò–∑–º–µ–Ω–µ–Ω–∏—è*:
          ${CHANGES//$'\t'/$'\n'}
          
          üìä *–î–µ—Ç–∞–ª–∏*:
          \`\`\`
          $DETAILS
          \`\`\`
          
          üîó *–°—Å—ã–ª–∫–∞*: $COMMIT_LINK"

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          echo "$MESSAGE" > message.txt
          echo "MESSAGE=$(jq -Rs < message.txt)" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          # –ß–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞
          MESSAGE=$(cat message.txt)
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º JSON –≤—Ä—É—á–Ω—É—é
          JSON_DATA='{
            "chat_id": "5615087670",
            "text": $MESSAGE,
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }'
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
