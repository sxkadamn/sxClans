name: Telegram Notify

on:
  push:

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # –ß—Ç–æ–±—ã –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–º–º–∏—Ç

      - name: Get commit message and diff
        id: commit_info
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:"%s%n%n%b")
          DIFF=$(git diff HEAD^ HEAD --stat)

          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã MarkdownV2
          escape() {
            echo "$1" | sed \
              -e 's/\\/\\\\/g' \
              -e 's/\*/\\*/g' -e 's/_/\\_/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' \
              -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/\~/\\~/g' -e 's/\`/\\`/g' \
              -e 's/>/\\>/g' -e 's/#/\\#/g' -e 's/\+/\\+/g' -e 's/\-/\\-/g' \
              -e 's/\=/\\=/g' -e 's/\!/\\!/g' -e 's/\./\\./g'
          }

          ESCAPED_MSG=$(escape "$COMMIT_MSG")
          ESCAPED_DIFF=$(escape "$DIFF")

          echo "COMMIT_MESSAGE=${ESCAPED_MSG}" >> $GITHUB_OUTPUT
          echo "COMMIT_DIFF=${ESCAPED_DIFF}" >> $GITHUB_OUTPUT
          echo "COMMIT_URL=https://github.com/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Send message to Telegram
        run: |
          TOKEN="7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q"
          CHAT_ID="5615087670"

          TEXT="üöÄ *–ù–æ–≤—ã–π –∫–æ–º–º–∏—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏*\n\nüìÑ *–û–ø–∏—Å–∞–Ω–∏–µ:*\n${{ steps.commit_info.outputs.COMMIT_MESSAGE }}\n\nüõ† *–ò–∑–º–µ–Ω–µ–Ω–∏—è:*\n\`\`\`\n${{ steps.commit_info.outputs.COMMIT_DIFF }}\n\`\`\`\nüîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub](${{ steps.commit_info.outputs.COMMIT_URL }})"

          JSON=$(jq -n \
            --arg chat_id "$CHAT_ID" \
            --arg text "$TEXT" \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: "MarkdownV2",
              disable_web_page_preview: true
            }')

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON" \
            "https://api.telegram.org/bot$TOKEN/sendMessage"
