name: Telegram Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare message
        run: |
          # Получаем данные
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | tr '\n' ',' | sed 's/,/, /g')
          
          # Формируем сообщение в одну строку
          MESSAGE="Новые изменения в ${GITHUB_REPOSITORY##*/} | Коммит: ${COMMIT_MSG} | Автор: ${GITHUB_ACTOR} | Файлы: ${CHANGED_FILES%,} | Ссылка: https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA}"
          
          # Сохраняем в файл
          echo "$MESSAGE" > message.txt
          echo "MESSAGE=$(cat message.txt)" >> $GITHUB_ENV

      - name: Send to Telegram
        run: |
          # Читаем сообщение из файла
          MESSAGE_CONTENT=$(cat message.txt)
          
          # Формируем простейший JSON
          JSON_DATA="{\"chat_id\":\"5615087670\",\"text\":\"$MESSAGE_CONTENT\"}"
          
          # Отправляем
          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
