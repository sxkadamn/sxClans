name: Git Changes Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare notification data
        id: prepare
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')
          COMMIT_LINK="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          CHANGES=$(git diff --name-status HEAD^ HEAD | while read status file; do
            case $status in
              A) echo "â€¢ ðŸ†• $file";;
              M) echo "â€¢ âœï¸ $file";;
              D) echo "â€¢ âŒ $file";;
              R*) echo "â€¢ â™»ï¸ ${file#*$'\t'}";;
              C) echo "â€¢ Â©ï¸ $file";;
              *) echo "â€¢ ðŸ”„ $file";;
            esac
          done | tr '\n' ' ')

          DETAILS=$(git diff --stat HEAD^ HEAD)
          
          MESSAGE_JSON=$(jq -n \
            --arg repo "${GITHUB_REPOSITORY##*/}" \
            --arg msg "$COMMIT_MSG" \
            --arg author "$AUTHOR" \
            --arg date "$DATE" \
            --arg changes "$CHANGES" \
            --arg details "$DETAILS" \
            --arg link "$COMMIT_LINK" \
            '{
              chat_id: "5615087670",
              text: ("ðŸ“Œ *ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ*: " + $repo + "\n\n" +
                    "ðŸ“ *ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚*: " + $msg + "\n" +
                    "ðŸ‘¤ *ÐÐ²Ñ‚Ð¾Ñ€*: " + $author + "\n" +
                    "ðŸ“… *Ð”Ð°Ñ‚Ð°*: " + $date + "\n\n" +
                    "ðŸ“‚ *Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ*:\n" + $changes + "\n\n" +
                    "ðŸ“Š *Ð”ÐµÑ‚Ð°Ð»Ð¸*:\n```\n" + $details + "\n```\n\n" +
                    "ðŸ”— *Ð¡ÑÑ‹Ð»ÐºÐ°*: " + $link),
              parse_mode: "MarkdownV2",
              disable_web_page_preview: true
            }')

          echo "MESSAGE_JSON=${MESSAGE_JSON}" >> $GITHUB_OUTPUT
          echo "Generated message:"
          echo "$MESSAGE_JSON" | jq -r '.text'

      - name: Send to Telegram
        run: |
          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d '${{ steps.prepare.outputs.MESSAGE_JSON }}' \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
