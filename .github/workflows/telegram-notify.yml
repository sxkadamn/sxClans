name: Git Changes Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare notification data
        id: prepare
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          COMMIT_MSG=$(git log -1 --pretty=format:'%s' | sed 's/"/\\"/g')
          AUTHOR=$(git log -1 --pretty=format:'%an' | sed 's/"/\\"/g')
          DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')
          COMMIT_LINK="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          CHANGES=$(git diff --name-status HEAD^ HEAD | awk '{
            if ($1 == "A") print "‚Ä¢ üÜï " $2;
            else if ($1 == "M") print "‚Ä¢ ‚úèÔ∏è " $2;
            else if ($1 == "D") print "‚Ä¢ ‚ùå " $2;
            else if ($1 ~ /^R/) print "‚Ä¢ ‚ôªÔ∏è " $3;
            else if ($1 == "C") print "‚Ä¢ ¬©Ô∏è " $2;
            else print "‚Ä¢ üîÑ " $2;
          }' | sed 's/"/\\"/g' | tr '\n' ' ')

          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π
          DETAILS=$(git diff --stat HEAD^ HEAD | sed 's/"/\\"/g')

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
          MESSAGE=$(printf 'üìå *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ*: %s\n\nüìù *–ö–æ–º–º–∏—Ç*: %s\nüë§ *–ê–≤—Ç–æ—Ä*: %s\nüìÖ *–î–∞—Ç–∞*: %s\n\nüìÇ *–ò–∑–º–µ–Ω–µ–Ω–∏—è*:\n%s\n\nüìä *–î–µ—Ç–∞–ª–∏*:\n```\n%s\n```\n\nüîó *–°—Å—ã–ª–∫–∞*: %s' \
            "${GITHUB_REPOSITORY##*/}" \
            "$COMMIT_MSG" \
            "$AUTHOR" \
            "$DATE" \
            "${CHANGES}" \
            "$DETAILS" \
            "$COMMIT_LINK")

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª —Å —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          echo "$MESSAGE" > message.txt
          echo "MESSAGE=$(jq -Rs < message.txt)" >> $GITHUB_OUTPUT

          echo "–°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ:"
          cat message.txt

      - name: Send to Telegram
        run: |
          # –ß–∏—Ç–∞–µ–º –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE_CONTENT=$(jq -Rs < message.txt)
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º JSON —Å –ø–æ–º–æ—â—å—é jq
          JSON_PAYLOAD=$(jq -n \
            --arg chat_id "5615087670" \
            --argjson text "$MESSAGE_CONTENT" \
            --arg parse_mode "MarkdownV2" \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: $parse_mode,
              disable_web_page_preview: true
            }')

          echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º payload:"
          echo "$JSON_PAYLOAD"

          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
