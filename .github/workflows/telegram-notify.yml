name: Git Changes Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare notification data
        id: prepare
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')
          COMMIT_LINK="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π
          CHANGES=$(git diff --name-status HEAD^ HEAD | while read status file; do
            case $status in
              A) echo "‚Ä¢ üÜï $file";;
              M) echo "‚Ä¢ ‚úèÔ∏è $file";;
              D) echo "‚Ä¢ ‚ùå $file";;
              R*) echo "‚Ä¢ ‚ôªÔ∏è ${file#*$'\t'}";;
              C) echo "‚Ä¢ ¬©Ô∏è $file";;
              *) echo "‚Ä¢ üîÑ $file";;
            done | tr '\n' '|')

          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π
          DETAILS=$(git diff --stat HEAD^ HEAD)

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
          MESSAGE=$(printf "üìå *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ*: %s\n\nüìù *–ö–æ–º–º–∏—Ç*: %s\nüë§ *–ê–≤—Ç–æ—Ä*: %s\nüìÖ *–î–∞—Ç–∞*: %s\n\nüìÇ *–ò–∑–º–µ–Ω–µ–Ω–∏—è*:\n%s\n\nüìä *–î–µ—Ç–∞–ª–∏*:\n\`\`\`\n%s\n\`\`\`\n\nüîó *–°—Å—ã–ª–∫–∞*: %s" \
            "${GITHUB_REPOSITORY##*/}" \
            "$COMMIT_MSG" \
            "$AUTHOR" \
            "$DATE" \
            "${CHANGES//|/$'\n'}" \
            "$DETAILS" \
            "$COMMIT_LINK")

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          echo "$MESSAGE" > message.txt
          echo "MESSAGE=$(cat message.txt | jq -Rs)" >> $GITHUB_OUTPUT

          echo "–°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ:"
          cat message.txt

      - name: Send to Telegram
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º JSON payload
          MESSAGE=$(cat message.txt)
          JSON_PAYLOAD=$(jq -n \
            --arg chat_id "5615087670" \
            --arg text "$MESSAGE" \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: "MarkdownV2",
              disable_web_page_preview: true
            }')

          echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º payload:"
          echo "$JSON_PAYLOAD" | jq .

          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
