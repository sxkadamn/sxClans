name: Telegram Channel Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare notification
        id: prepare
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∫–æ–º–º–∏—Ç–æ–≤
          COMMIT_HASH=$(git log -1 --pretty=format:'%h')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s' | sed -e 's/[][_*`]/\\&/g')
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')
          COMMIT_LINK="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | tr '\n' ',' | sed 's/,/, /g; s/[][_*`]/\\&/g')

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          MESSAGE=$(cat <<EOF
          üöÄ *–ù–æ–≤—ã–π –∫–æ–¥ –≤ –ø—Ä–æ–µ–∫—Ç–µ* \\[${GITHUB_REPOSITORY##*///_/\\_}\\]
          
          üìù *–ö–æ–º–º–∏—Ç:* [${COMMIT_HASH//_/\\_}](${COMMIT_LINK})
          ‚úçÔ∏è *–ê–≤—Ç–æ—Ä:* ${COMMIT_AUTHOR//_/\\_}
          üìÖ *–î–∞—Ç–∞:* ${COMMIT_DATE}
          
          üí¨ *–°–æ–æ–±—â–µ–Ω–∏–µ:*
          \`\`\`
          ${COMMIT_MESSAGE}
          \`\`\`
          
          üìÇ *–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:*
          \`\`\`
          ${CHANGED_FILES%, }
          \`\`\`
          
          üîç *–ü–æ–ª–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:*
          [–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub](${COMMIT_LINK})
          EOF
          )

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
          echo "${MESSAGE}" > message.txt
          echo "MESSAGE=$(cat message.txt | jq -Rs)" >> $GITHUB_OUTPUT

          echo "–°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ:"
          echo "${MESSAGE}"

      - name: Send to Telegram Channel
        run: |
          # –ß–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞
          MESSAGE=$(cat message.txt)
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º JSON –≤—Ä—É—á–Ω—É—é
          JSON_PAYLOAD=$(jq -n \
            --arg chat_id "5615087670" \
            --arg text "$MESSAGE" \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: "MarkdownV2",
              disable_web_page_preview: false
            }')
          
          echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º payload:"
          echo "$JSON_PAYLOAD" | jq .

          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
