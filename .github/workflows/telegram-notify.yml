name: AI Git Analyzer
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get git diff
        id: git_diff
        run: |
          git diff HEAD^ HEAD > diff.txt
          echo "DIFF_CONTENT=$(jq -Rs < diff.txt)" >> $GITHUB_OUTPUT
          echo "DIFF_LINES=$(wc -l < diff.txt)" >> $GITHUB_OUTPUT

      - name: Analyze with AI
        id: ai_analysis
        uses: actions/github-script@v6
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF: ${{ steps.git_diff.outputs.DIFF_CONTENT }}
        with:
          script: |
            const {OPENAI_KEY, DIFF} = process.env;
            try {
              const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${OPENAI_KEY}`
                },
                body: JSON.stringify({
                  model: "gpt-3.5-turbo",
                  messages: [{
                    role: "user",
                    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:\n${DIFF}\n\n–ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥:`
                  }],
                  temperature: 0.7,
                  max_tokens: 500
                })
              });

              const data = await response.json();
              if (!data.choices?.[0]?.message?.content) {
                throw new Error('Invalid response from OpenAI');
              }
              return data.choices[0].message.content;
            } catch (error) {
              return `‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${error.message}`;
            }

      - name: Prepare Telegram message
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª–µ
          cat <<EOF > message.txt
          ü§ñ *AI –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π*:

          ${{ steps.ai_analysis.outputs.result }}

          üîó *–ö–æ–º–º–∏—Ç*: https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA
          EOF
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
          echo "MESSAGE=$(cat message.txt | jq -Rs)" >> $GITHUB_ENV

      - name: Send to Telegram
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º jq –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          JSON_PAYLOAD=$(jq -n \
            --arg chat_id "5615087670" \
            --arg text "$(cat message.txt)" \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: "MarkdownV2",
              disable_web_page_preview: true
            }')
          
          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
