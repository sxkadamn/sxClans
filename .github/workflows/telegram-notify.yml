name: Telegram Notify
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Extract commit data
        id: git-info
        run: |
          # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è MarkdownV2
          LAST_COMMIT=$(git log -1 --pretty=format:'%h - %an: %s (%cr)' | sed -e 's/[_\*\[\]()~`>#\+\-=|{}\.!]/\\&/g')
          ALL_COMMITS=$(git log --pretty=format:'‚Ä¢ %h - %an: %s (%cr)' HEAD^..HEAD | sed -e 's/[_\*\[\]()~`>#\+\-=|{}\.!]/\\&/g')
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD | sed -e 's/[_\*\[\]()~`>#\+\-=|{}\.!]/\\&/g')
          
          echo "LAST_COMMIT=${LAST_COMMIT}" >> $GITHUB_OUTPUT
          echo "ALL_COMMITS=${ALL_COMMITS}" >> $GITHUB_OUTPUT
          echo "CHANGED_FILES=${CHANGED_FILES}" >> $GITHUB_OUTPUT
          echo "VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo 'dev')" >> $GITHUB_OUTPUT

      - name: Compose notification
        id: compose
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          MESSAGE=$(cat <<EOF
          üîî *–ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏* \\[${GITHUB_REPOSITORY//_/\\_}\\]
          
          üìå *–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç:*
          \`\`\`
          ${{ steps.git-info.outputs.LAST_COMMIT }}
          \`\`\`
          
          üìã *–í—Å–µ –∫–æ–º–º–∏—Ç—ã:*
          ${{ steps.git-info.outputs.ALL_COMMITS }}
          
          üìÇ *–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:*
          \`\`\`
          ${{ steps.git-info.outputs.CHANGED_FILES }}
          \`\`\`
          
          üë§ *–ê–≤—Ç–æ—Ä:* ${GITHUB_ACTOR//_/\\_}
          üè∑ *–í–µ—Ä—Å–∏—è:* ${{ steps.git-info.outputs.VERSION }}
          üîó *–°—Å—ã–ª–∫–∞:* [–û—Ç–∫—Ä—ã—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è](https://github.com/${GITHUB_REPOSITORY}/commit/${GITHUB_SHA})
          EOF
          )
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ output
          MESSAGE_JSON=$(jq -n --arg msg "$MESSAGE" '{message: $msg}')
          echo "MESSAGE_JSON=${MESSAGE_JSON}" >> $GITHUB_OUTPUT
          echo "–°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ:"
          echo "${MESSAGE}"

      - name: Send to Telegram
        run: |
          curl -v -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": ${{ steps.compose.outputs.MESSAGE_JSON }.message},
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }' \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
