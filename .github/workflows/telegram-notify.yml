name: Telegram Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup debug info
        id: debug
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–º–∏—Ç–∞—Ö
          COMMITS=$(git log --pretty=format:'%h - %an: %s' HEAD^..HEAD)
          echo "COMMITS=${COMMITS}" >> $GITHUB_OUTPUT
          
          # –ü–æ–ª—É—á–∞–µ–º –≤–µ—Ä—Å–∏—é
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo 'dev')
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          echo "RAW_MESSAGE=üìå –ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ ${GITHUB_REPOSITORY}" >> $GITHUB_OUTPUT
          echo "RAW_MESSAGE+=%0A%0A–ö–æ–º–º–∏—Ç—ã:%0A${COMMITS}" >> $GITHUB_OUTPUT
          echo "RAW_MESSAGE+=%0A%0A–ê–≤—Ç–æ—Ä: ${GITHUB_ACTOR}" >> $GITHUB_OUTPUT
          echo "RAW_MESSAGE+=%0A–í–µ—Ä—Å–∏—è: ${VERSION}" >> $GITHUB_OUTPUT

      - name: Show debug info
        run: |
          echo "=== Debug Information ==="
          echo "GITHUB_REPOSITORY: ${GITHUB_REPOSITORY}"
          echo "GITHUB_ACTOR: ${GITHUB_ACTOR}"
          echo "COMMITS: ${{ steps.debug.outputs.COMMITS }}"
          echo "VERSION: ${{ steps.debug.outputs.VERSION }}"
          echo "RAW_MESSAGE: ${{ steps.debug.outputs.RAW_MESSAGE }}"
          echo "========================="

      - name: Test Telegram API connection
        run: |
          echo "Sending test ping to Telegram..."
          curl -s -X GET "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/getMe"

      - name: Send simple test message
        run: |
          curl -v -X POST \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage" \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": "Test message from GitHub Actions workflow",
            "disable_notification": false
          }'

      - name: Send actual notification
        run: |
          curl -v -X POST \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage" \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": "üìå –ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ ${GITHUB_REPOSITORY}\n\n–ö–æ–º–º–∏—Ç—ã:\n${{ steps.debug.outputs.COMMITS }}\n\n–ê–≤—Ç–æ—Ä: ${GITHUB_ACTOR}\n–í–µ—Ä—Å–∏—è: ${{ steps.debug.outputs.VERSION }}",
            "parse_mode": "HTML",
            "disable_web_page_preview": true
          }'
