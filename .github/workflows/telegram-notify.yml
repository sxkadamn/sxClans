name: AI Git Changes Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Analyze changes with AI
        id: ai_analysis
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # –ü–æ–ª—É—á–∞–µ–º diff –º–µ–∂–¥—É –∫–æ–º–º–∏—Ç–∞–º–∏
          DIFF_CONTENT=$(git diff HEAD^ HEAD)
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ ChatGPT
          ANALYSIS=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_KEY" \
            -d '{
              "model": "gpt-3.5-turbo",
              "messages": [
                {
                  "role": "system", 
                  "content": "–¢—ã - —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–∏—Å–∞—Ç–µ–ª—å. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π git diff –∏ –æ–±—ä—è—Å–Ω—è–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–Ω—è—Ç–Ω—ã–º —è–∑—ã–∫–æ–º –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤. –§–æ—Ä–º–∞—Ç:\n‚Ä¢ [–¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è]: [–§–∞–π–ª] - [–û–±—ä—è—Å–Ω–µ–Ω–∏–µ]\n‚Ä¢ –ü—Ä–∏–º–µ—Ä: \"‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: player/movement.cs - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π\""
                },
                {
                  "role": "user",
                  "content": "'"$DIFF_CONTENT"'"
                }
              ],
              "temperature": 0.7
            }' | jq -r '.choices[0].message.content')
          
          echo "ANALYSIS<<EOF" >> $GITHUB_OUTPUT
          echo "$ANALYSIS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Compose message
        run: |
          # –ë–∞–∑–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–º–º–∏—Ç–∞
          COMMIT_INFO=$(git log -1 --pretty=format:'üìå *–ö–æ–º–º–∏—Ç*: %s\nüë§ *–ê–≤—Ç–æ—Ä*: %an\nüìÖ *–î–∞—Ç–∞*: %cd' --date=format:'%Y-%m-%d %H:%M')
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="üöÄ *–î–µ—Ç–∞–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è*: ${GITHUB_REPOSITORY##*/}\n\n${COMMIT_INFO}\n\n${{ steps.ai_analysis.outputs.ANALYSIS }}\n\nüîó *–ü–æ–ª–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è*: https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          
          echo "$MESSAGE" > message.txt
          echo "MESSAGE=$(jq -Rs < message.txt)" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": '"$(cat message.txt | jq -Rs)"',
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }' \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
