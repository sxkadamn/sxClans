name: AI Git Analyzer
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get git diff
        id: git_diff
        run: |
          echo "DIFF<<EOF" >> $GITHUB_OUTPUT
          git diff HEAD^ HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze with AI
        id: ai_analysis
        uses: actions/github-script@v6
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF: ${{ steps.git_diff.outputs.DIFF }}
        with:
          script: |
            const { OPENAI_KEY, DIFF } = process.env;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç –¥–ª—è AI
            const prompt = `
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç git diff –∏ —Å–æ–∑–¥–∞–π –∫—Ä–∞—Ç–∫–∏–π –æ—Ç—á–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º:
            1. –¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ñ–∏—á–∞, –±–∞–≥—Ñ–∏–∫—Å, —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥)
            2. –û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
            3. –°—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
            4. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∏–≥—Ä–æ–∫–æ–≤
            
            Diff:
            ${DIFF}
            `;

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_KEY}`
              },
              body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [{role: "user", content: prompt}],
                temperature: 0.7
              })
            });

            const data = await response.json();
            return data.choices[0].message.content;

      - name: Send to Telegram
        run: |
          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
          MESSAGE="ü§ñ *AI –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π*:\n\n"\
          "${{ steps.ai_analysis.outputs.result }}\n\n"\
          "üîó *–°—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–º–∏—Ç*:\n"\
          "https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ curl
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "5615087670",
              "text": "'"$MESSAGE"'",
              "parse_mode": "MarkdownV2",
              "disable_web_page_preview": true
            }' \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
