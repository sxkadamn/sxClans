name: AI-Powered Telegram Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get git diff
        id: git_diff
        run: |
          DIFF=$(git diff HEAD^ HEAD)
          echo "DIFF<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze changes with AI
        id: ai_analysis
        uses: actions/github-script@v6
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF: ${{ steps.git_diff.outputs.DIFF }}
        with:
          script: |
            const { DIFF, OPENAI_KEY } = process.env;
            const prompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç git diff –∏ –∫—Ä–∞—Ç–∫–æ –æ–ø–∏—à–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤:\n\n${DIFF}\n\n–§–æ—Ä–º–∞—Ç: "‚Ä¢ [–¢–∏–ø]: [–§–∞–π–ª] - [–û–ø–∏—Å–∞–Ω–∏–µ]"`;
            
            try {
              const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${OPENAI_KEY}`
                },
                body: JSON.stringify({
                  model: "gpt-3.5-turbo",
                  messages: [{role: "user", content: prompt}],
                  temperature: 0.7
                })
              });

              const data = await response.json();
              
              if (data.choices && data.choices.length > 0 && data.choices[0].message) {
                core.setOutput('result', data.choices[0].message.content);
              } else {
                core.setFailed('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI API');
              }
            } catch (error) {
              core.setFailed(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: ${error.message}`);
            }

      - name: Send notification
        if: steps.ai_analysis.outputs.result
        run: |
          MESSAGE="üß† *AI-–∞–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π*:\n\n${{ steps.ai_analysis.outputs.result }}\n\nüîó –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": "'"$MESSAGE"'",
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }' \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
