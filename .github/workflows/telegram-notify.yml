name: Telegram Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get commit info
        id: commits
        run: |
          echo "COMMITS=$(git log --pretty=format:'%h - %an: %s' HEAD^..HEAD | sed 's/[][_*`]/\\&/g')" >> $GITHUB_OUTPUT
          echo "VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo '0.0.1')" >> $GITHUB_OUTPUT
          echo "Generated commit info:"
          git log --pretty=format:'%h - %an: %s' HEAD^..HEAD
      
      - name: Test Telegram API
        run: |
          curl -s -X POST \
          -H "Content-Type: application/json" \
          -d '{"chat_id": "5615087670", "text": "Test message from GitHub Actions"}' \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage" \
          && echo -e "\nTelegram API request sent successfully" \
          || echo -e "\nFailed to send Telegram message"
      
      - name: Send formatted notification
        run: |
          curl -v -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": "üìå –ù–æ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ ${GITHUB_REPOSITORY}\n\n–ö–æ–º–º–∏—Ç—ã:\n${{ steps.commits.outputs.COMMITS }}\n\n–ê–≤—Ç–æ—Ä: ${GITHUB_ACTOR}\n–í–µ—Ä—Å–∏—è: ${{ steps.commits.outputs.VERSION }}",
            "parse_mode": "HTML"
          }' \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
