name: Git Changes Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare notification data
        id: prepare
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')
          COMMIT_LINK="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          CHANGES=$(git diff --name-status HEAD^ HEAD | while read status file; do
            case $status in
              A) echo "â€¢ ðŸ†• $file";;
              M) echo "â€¢ âœï¸ $file";;
              D) echo "â€¢ âŒ $file";;
              R*) echo "â€¢ â™»ï¸ ${file#*$'\t'}";;
              C) echo "â€¢ Â©ï¸ $file";;
              *) echo "â€¢ ðŸ”„ $file";;
            done | tr '\n' '\t')

          DETAILS=$(git diff --stat HEAD^ HEAD)

          MESSAGE="ðŸ“Œ *ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð² Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ*: ${GITHUB_REPOSITORY##*/}
          
          ðŸ“ *ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚*: $COMMIT_MSG
          ðŸ‘¤ *ÐÐ²Ñ‚Ð¾Ñ€*: $AUTHOR
          ðŸ“… *Ð”Ð°Ñ‚Ð°*: $DATE
          
          ðŸ“‚ *Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ*:
          ${CHANGES//$'\t'/$'\n'}
          
          ðŸ“Š *Ð”ÐµÑ‚Ð°Ð»Ð¸*:
          \`\`\`
          $DETAILS
          \`\`\`
          
          ðŸ”— *Ð¡ÑÑ‹Ð»ÐºÐ°*: $COMMIT_LINK"

          echo "$MESSAGE" > message.txt
          echo "MESSAGE=$(jq -Rs < message.txt)" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          MESSAGE=$(cat message.txt)
          
          JSON_DATA='{
            "chat_id": "5615087670",
            "text": $MESSAGE,
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }'
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
