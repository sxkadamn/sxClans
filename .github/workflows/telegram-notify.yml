name: Git Changes Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare notification data
        id: prepare
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')
          COMMIT_LINK="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
          CHANGES=$(git diff --name-status HEAD^ HEAD | awk '{
            if ($1 == "A") print "‚Ä¢ üÜï " $2;
            else if ($1 == "M") print "‚Ä¢ ‚úèÔ∏è " $2;
            else if ($1 == "D") print "‚Ä¢ ‚ùå " $2;
            else if ($1 ~ /^R/) print "‚Ä¢ ‚ôªÔ∏è " $3;
            else if ($1 == "C") print "‚Ä¢ ¬©Ô∏è " $2;
            else print "‚Ä¢ üîÑ " $2;
          }' | tr '\n' ' ')

          # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑–º–µ–Ω–µ–Ω–∏–π
          DETAILS=$(git diff --stat HEAD^ HEAD)

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å)
          MESSAGE="üìå *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ*: ${GITHUB_REPOSITORY##*/}
          
          üìù *–ö–æ–º–º–∏—Ç*: ${COMMIT_MSG}
          üë§ *–ê–≤—Ç–æ—Ä*: ${AUTHOR}
          üìÖ *–î–∞—Ç–∞*: ${DATE}
          
          üìÇ *–ò–∑–º–µ–Ω–µ–Ω–∏—è*:
          ${CHANGES}
          
          üìä *–î–µ—Ç–∞–ª–∏*:
          \`\`\`
          ${DETAILS}
          \`\`\`
          
          üîó *–°—Å—ã–ª–∫–∞*: ${COMMIT_LINK}"

          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
          echo "$MESSAGE" > message.txt
          echo "MESSAGE=$(jq -Rs < message.txt)" >> $GITHUB_OUTPUT

          echo "–°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ:"
          cat message.txt

      - name: Send to Telegram
        run: |
          # –ß–∏—Ç–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ —Ñ–∞–π–ª–∞
          MESSAGE_CONTENT=$(cat message.txt)
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º JSON payload
          JSON_PAYLOAD='{
            "chat_id": "5615087670",
            "text": '"$(jq -n --arg msg "$MESSAGE_CONTENT" '$msg')"',
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }'

          echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º payload:"
          echo "$JSON_PAYLOAD" | jq .

          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/send
