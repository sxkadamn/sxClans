name: AI-Powered Telegram Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Analyze changes with AI
        id: ai_analysis
        uses: actions/github-script@v6
        env:
          DIFF: $(git diff HEAD^ HEAD)
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            const { DIFF, OPENAI_KEY } = process.env;
            const prompt = `
            –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π git diff –∏ –æ–±—ä—è—Å–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º –¥–ª—è –∏–≥—Ä–æ–∫–æ–≤:
            ${DIFF}
            
            –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:
            ‚Ä¢ [–¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏—è]: [–§–∞–π–ª] - [–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å]
            ‚Ä¢ –ü—Ä–∏–º–µ—Ä: "‚Ä¢ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: player/movement.cs - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π —Å –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è–º–∏"
            `;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${OPENAI_KEY}`
              },
              body: JSON.stringify({
                model: "gpt-3.5-turbo",
                messages: [{role: "user", content: prompt}],
                temperature: 0.7
              })
            });

            const data = await response.json();
            return data.choices[0].message.content;

      - name: Send AI analysis to Telegram
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": "üß† *AI-–∞–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π*:\n\n${{ steps.ai_analysis.outputs.result }}\n\nüîó –ü–æ–ª–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA",
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }' \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
