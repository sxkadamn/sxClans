name: Simple Git Notifier

on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit info
        id: commit_info
        run: |
          echo "COMMIT_MESSAGE<<EOF" >> $GITHUB_OUTPUT
          git log -1 --pretty=%B >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "COMMIT_URL=https://github.com/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_OUTPUT

          echo "GIT_DIFF<<EOF" >> $GITHUB_OUTPUT
          git diff HEAD^ HEAD --stat >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send to Telegram
        run: |
          TELEGRAM_BOT_TOKEN="7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q"
          CHAT_ID="5615087670"

          COMMIT_MESSAGE="${{ steps.commit_info.outputs.COMMIT_MESSAGE }}"
          COMMIT_URL="${{ steps.commit_info.outputs.COMMIT_URL }}"
          GIT_DIFF="${{ steps.commit_info.outputs.GIT_DIFF }}"

          escape_markdown() {
            echo "$1" | sed \
              -e 's/\*/\\*/g' -e 's/_/\\_/g' -e 's/\[/\\[/g' -e 's/\]/\\]/g' \
              -e 's/(/\\(/g' -e 's/)/\\)/g' -e 's/\~/\\~/g' -e 's/\`/\\`/g' \
              -e 's/>/\\>/g' -e 's/#/\\#/g' -e 's/\+/\\+/g' -e 's/\-/\\-/g' \
              -e 's/=/\\=/g' -e 's/!/\\!/g' -e 's/\./\\./g'
          }

          ESCAPED_COMMIT_MESSAGE=$(escape_markdown "$COMMIT_MESSAGE")
          ESCAPED_DIFF=$(escape_markdown "$GIT_DIFF")

          MESSAGE="üöÄ *–ù–æ–≤—ã–π –∫–æ–º–º–∏—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:*\n\nüìÑ *–û–ø–∏—Å–∞–Ω–∏–µ:* ${ESCAPED_COMMIT_MESSAGE}\n\nüõ† *–ò–∑–º–µ–Ω–µ–Ω–∏—è:*\n\`\`\`\n${ESCAPED_DIFF}\n\`\`\`\nüîó [–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ GitHub](${COMMIT_URL})"

          JSON_PAYLOAD=$(jq -n \
            --arg chat_id "$CHAT_ID" \
            --arg text "$MESSAGE" \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: "MarkdownV2",
              disable_web_page_preview: true
            }')

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"
