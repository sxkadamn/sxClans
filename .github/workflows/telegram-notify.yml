name: AI Git Analyzer (Fixed)
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get git diff
        id: git_diff
        run: |
          echo "DIFF<<EOF" >> $GITHUB_OUTPUT
          git diff HEAD^ HEAD >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Analyze with AI (Fixed)
        id: ai_analysis
        uses: actions/github-script@v6
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF: ${{ steps.git_diff.outputs.DIFF }}
        with:
          script: |
            const { OPENAI_KEY, DIFF } = process.env;
            
            try {
              const prompt = `–ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç git diff –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–æ–¥—Ä–æ–±–Ω–æ:\n${DIFF}\n\n–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:
1. –¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω–∏–π (—Ñ–∏—á–∞/–±–∞–≥—Ñ–∏–∫—Å/—Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥)
2. –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
3. –°—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π
4. –í–ª–∏—è–Ω–∏–µ –Ω–∞ –∏–≥—Ä–æ–∫–æ–≤`;

              const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${OPENAI_KEY}`
                },
                body: JSON.stringify({
                  model: "gpt-3.5-turbo",
                  messages: [{role: "user", content: prompt}],
                  temperature: 0.7
                })
              });

              const data = await response.json();
              
              if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç OpenAI');
              }

              return data.choices[0].message.content;
            } catch (error) {
              core.setFailed(`AI –∞–Ω–∞–ª–∏–∑ –Ω–µ —É–¥–∞–ª—Å—è: ${error.message}`);
              return "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è";
            }

      - name: Send to Telegram
        run: |
          MESSAGE="ü§ñ *AI –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π*:\n\n"\
          "${{ steps.ai_analysis.outputs.result }}\n\n"\
          "üîó –°—Å—ã–ª–∫–∞: https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "chat_id": "5615087670",
              "text": "'"$MESSAGE"'",
              "parse_mode": "MarkdownV2",
              "disable_web_page_preview": true
            }' \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
