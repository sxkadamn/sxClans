name: AI Git Analyzer

on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get git diff
        id: git_diff
        run: |
          git diff HEAD^ HEAD > diff.txt
          echo "DIFF_CONTENT=$(jq -Rs < diff.txt)" >> $GITHUB_OUTPUT
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> $GITHUB_OUTPUT

      - name: Analyze with AI (optional)
        id: ai_analysis
        uses: actions/github-script@v6
        continue-on-error: true
        env:
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          DIFF: ${{ steps.git_diff.outputs.DIFF_CONTENT }}
        with:
          script: |
            const core = require('@actions/core');
            const { OPENAI_KEY, DIFF } = process.env;

            if (!OPENAI_KEY) {
              core.setOutput("result", "üîç OpenAI –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω. –û—Ç–ø—Ä–∞–≤–ª—è—é –æ–±—ã—á–Ω—ã–π diff.");
              return;
            }

            try {
              const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${OPENAI_KEY}`
                },
                body: JSON.stringify({
                  model: "gpt-3.5-turbo",
                  messages: [{
                    role: "user",
                    content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:\n${DIFF}\n\n–ö—Ä–∞—Ç–∫–∏–π –≤—ã–≤–æ–¥:`
                  }],
                  temperature: 0.7,
                  max_tokens: 500
                })
              });

              const data = await response.json();
              const result = data.choices?.[0]?.message?.content || '‚ö†Ô∏è –û—Ç–≤–µ—Ç –æ—Ç OpenAI –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç';
              core.setOutput("result", result);
            } catch (error) {
              core.setOutput("result", `‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ${error.message}\n\nüì¶ –û–±—ã—á–Ω—ã–π diff:\n${DIFF}`);
            }

      - name: Send to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          RAW_TEXT="${{ steps.ai_analysis.outputs.result }}"
          FALLBACK_TEXT="*–ö–æ–º–º–∏—Ç:* _${{ steps.git_diff.outputs.COMMIT_MESSAGE }}_"

          ESCAPED_TEXT=$(echo "$RAW_TEXT" | sed \
            -e 's/\*/\\*/g' \
            -e 's/_/\\_/g' \
            -e 's/\[/\\[/g' \
            -e 's/\]/\\]/g' \
            -e 's/(/\\(/g' \
            -e 's/)/\\)/g' \
            -e 's/\~/\\~/g' \
            -e 's/\`/\\`/g' \
            -e 's/>/\\>/g' \
            -e 's/#/\\#/g' \
            -e 's/\+/\\+/g' \
            -e 's/\-/\\-/g' \
            -e 's/=/\\=/g' \
            -e 's/!/\\!/g' \
            -e 's/\./\\./g')

          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"

          MESSAGE="ü§ñ *AI –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:*\n\n$ESCAPED_TEXT\n\nüîó *–°—Å—ã–ª–∫–∞:* [$GITHUB_SHA]($COMMIT_URL)\n\n$FALLBACK_TEXT"

          JSON_PAYLOAD=$(jq -n \
            --arg chat_id "5615087670" \
            --arg text "$MESSAGE" \
            '{
              chat_id: $chat_id,
              text: $text,
              parse_mode: "MarkdownV2",
              disable_web_page_preview: true
            }')

          curl -s -X POST \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
