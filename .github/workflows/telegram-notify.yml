name: Git Changes Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Prepare notification data
        id: prepare
        run: |
          COMMIT_MSG=$(git log -1 --pretty=format:'%s')
          AUTHOR=$(git log -1 --pretty=format:'%an')
          DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')
          COMMIT_LINK="https://github.com/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"

          CHANGES=$(
            git diff --name-status HEAD^ HEAD | while read status file; do
              case "$status" in
                "A") echo "‚Ä¢ üÜï $file";;
                "M") echo "‚Ä¢ ‚úèÔ∏è $file";;
                "D") echo "‚Ä¢ ‚ùå $file";;
                "R"*) echo "‚Ä¢ ‚ôªÔ∏è ${file#*$'\t'}";;
                "C") echo "‚Ä¢ ¬©Ô∏è $file";;
                *) echo "‚Ä¢ üîÑ $file";;
              esac
            done | tr '\n' '\t'
          )

          DETAILS=$(git diff --stat HEAD^ HEAD)

          MESSAGE=$(
            cat <<-EOF
            üìå *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ*: ${GITHUB_REPOSITORY##*/}
            
            üìù *–ö–æ–º–º–∏—Ç*: ${COMMIT_MSG}
            üë§ *–ê–≤—Ç–æ—Ä*: ${AUTHOR}
            üìÖ *–î–∞—Ç–∞*: ${DATE}
            
            üìÇ *–ò–∑–º–µ–Ω–µ–Ω–∏—è*:
            ${CHANGES//$'\t'/$'\n'}
            
            üìä *–î–µ—Ç–∞–ª–∏*:
            \`\`\`
            ${DETAILS}
            \`\`\`
            
            üîó *–°—Å—ã–ª–∫–∞*: ${COMMIT_LINK}
            EOF
          )

          echo "${MESSAGE}" > message.txt
          echo "MESSAGE=$(jq -Rs < message.txt)" >> $GITHUB_OUTPUT

          echo "–°–æ–æ–±—â–µ–Ω–∏–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–æ:"
          cat message.txt

      - name: Send to Telegram
        run: |
          MESSAGE_CONTENT=$(cat message.txt)
          
          JSON_PAYLOAD=$(
            jq -n \
              --arg chat_id "5615087670" \
              --arg text "$MESSAGE_CONTENT" \
              '{
                chat_id: $chat_id,
                text: $text,
                parse_mode: "MarkdownV2",
                disable_web_page_preview: true
              }'
          )

          echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º payload:"
          echo "${JSON_PAYLOAD}" | jq .

          curl -v -X POST \
            -H "Content-Type: application/json" \
            -d "${JSON_PAYLOAD}" \
            "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
