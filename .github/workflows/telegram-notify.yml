name: Detailed Telegram Notifier
on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 

      - name: Get changes details
        id: changes
        run: |
          DIFF_CONTENT=$(git diff HEAD^ HEAD --stat)
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD)
          COMMIT_MSG=$(git log -1 --pretty=format:'%h - %s')
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT_DATE=$(git log -1 --pretty=format:'%cd' --date=format:'%Y-%m-%d %H:%M')

          echo "DIFF_CONTENT<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF_CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "CHANGED_FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "COMMIT_MSG=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "COMMIT_AUTHOR=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "COMMIT_DATE=$COMMIT_DATE" >> $GITHUB_OUTPUT

      - name: Compose detailed message
        run: |
          MESSAGE="üîÑ *–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ–µ–∫—Ç–µ*: ${GITHUB_REPOSITORY##*/}
          
          üìù *–ö–æ–º–º–∏—Ç*: ${{ steps.changes.outputs.COMMIT_MSG }}
          üë§ *–ê–≤—Ç–æ—Ä*: ${{ steps.changes.outputs.COMMIT_AUTHOR }}
          üìÖ *–î–∞—Ç–∞*: ${{ steps.changes.outputs.COMMIT_DATE }}
          
          üìÇ *–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã*:
          \`\`\`
          ${{ steps.changes.outputs.CHANGED_FILES }}
          \`\`\`
          
          üìä *–î–µ—Ç–∞–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π*:
          \`\`\`
          ${{ steps.changes.outputs.DIFF_CONTENT }}
          \`\`\`"

          echo "MESSAGE<<EOF" >> $GITHUB_ENV
          echo "$MESSAGE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Send to Telegram
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "chat_id": "5615087670",
            "text": "${{ env.MESSAGE }}",
            "parse_mode": "MarkdownV2",
            "disable_web_page_preview": true
          }' \
          "https://api.telegram.org/bot7715307360:AAFvEpydlOSPY_pGT51AbExRAaECg-1P06Q/sendMessage"
