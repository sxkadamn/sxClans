name: Telegram Devlog Notifier

on:
  push:
    branches: [ main ]

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð²

    - name: Prepare message
      id: prepare
      run: |
        # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ…
        COMMITS=$(git log --pretty=format:"â€¢ %h - %s (by %an)" -n 5)
        REPO_URL=$(git remote get-url origin | sed 's/\.git$//')
        
        # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Markdown-ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
        MESSAGE="ðŸ”„ *ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð² sxClans*:\n${COMMITS}\n\nðŸŒ [Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹](${REPO_URL})"
        
        # Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð»Ñ JSON
        ESCAPED_MSG=$(echo "$MESSAGE" | jq -Rs .)
        echo "message=${ESCAPED_MSG}" >> $GITHUB_OUTPUT

    - name: Send to Telegram
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: ${{ steps.prepare.outputs.message }}
        parse_mode: markdown
